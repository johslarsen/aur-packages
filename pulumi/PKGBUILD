# Maintainer: Wuxxin <wuxxin@gmail.com>
# Based on arch:extra:pulumi; original contributors:
# Contributor: Andrew Crerar <crerar@archlinux.org>
# Contributor#: Christian Rebischke <chris.rebischke@archlinux.org>
# Contributor: Christoph Gysin <christoph.gysin@gmail.com>

pkgname=pulumi-git
_pkgname=pulumi
pkgrel=1
pkgdesc='Modern Infrastructure as Code - git tag build with python+ nodejs dynamic resource provider'
arch=('x86_64')
url="https://github.com/pulumi/pulumi"
license=('Apache')

_get_latest_tag() {
  git ls-remote --tags --sort=-v:refname "$url" |
    head -n 1 | awk '{print $2}' | sed 's|refs/tags/||; s/^v//'
}
_latest_tag=$(_get_latest_tag)
pkgver=$_latest_tag

depends=('glibc')
makedepends=('go' 'git')
source=("${pkgname}::git+${url}.git")
sha256sums=('SKIP')

conflicts=('pulumi')
provides=('pulumi' "pulumi=${pkgver}")

_plugin_dirs=(
  "go/pulumi-language-go"
  "python/cmd/pulumi-language-python"
  "nodejs/cmd/pulumi-language-nodejs"
)

prepare() {
  cd "${srcdir}/${pkgname}"
  git fetch --tags
  git checkout "v$_latest_tag"
}

build() {
  cd "${srcdir}/${pkgname}"

  export CGO_CPPFLAGS="${CPPFLAGS}"
  export CGO_CFLAGS="${CFLAGS}"
  export CGO_CXXFLAGS="${CXXFLAGS}"
  export CGO_LDFLAGS="${LDFLAGS}"
  export GOFLAGS="-buildmode=pie -trimpath -mod=readonly -modcacherw"

  local _full_ver="v${_latest_tag}"
  local _major_ver="${_full_ver%%.*}"

  # Build the main executable
  cd pkg
  go build -ldflags \
    "-linkmode external -X github.com/pulumi/pulumi/sdk/${_major_ver}/go/common/version.Version=${_full_ver}" \
    -o "bin/${_pkgname}" "./cmd/${_pkgname}"
  
  # Build the plugins
  cd ../sdk
  for _plugin_path in "${_plugin_dirs[@]}"; do
    go build -ldflags "-linkmode external -X github.com/pulumi/pulumi/sdk/${_major_ver}/go/common/version.Version=${_full_ver}" \
      -o "../bin/${_plugin_path##*/}" "./${_plugin_path}"
  done

  # Copy additional files of plugins
  cp python/cmd/pulumi-language-python-exec bin/
  cp python/dist/pulumi-resource-pulumi-python bin/
  cp python/dist/pulumi-analyzer-policy-python bin/
  cp nodejs/dist/pulumi-resource-pulumi-nodejs bin/
  cp nodejs/dist/pulumi-analyzer-policy bin/
}

package() {
  cd "${srcdir}/${pkgname}"

  # Install all executables
  install -Dm755 bin/* -t "${pkgdir}/usr/bin/"

  # Generate Bash completion
  "${pkgdir}/usr/bin/${pkgname}" gen-completion bash > "${pkgdir}/etc/bash_completion.d/${pkgname}"
  install -Dm644 "${pkgdir}/etc/bash_completion.d/${pkgname}" "${pkgdir}/etc/bash_completion.d/${pkgname}"  # Ensure permissions

  # Generate ZSH completion
  "${pkgdir}/usr/bin/${pkgname}" gen-completion zsh > "${pkgdir}/usr/share/zsh/site-functions/_${pkgname}"
  install -Dm644 "${pkgdir}/usr/share/zsh/site-functions/_${pkgname}" "${pkgdir}/usr/share/zsh/site-functions/_${pkgname}"

  # Generate Fish completion
  "${pkgdir}/usr/bin/${pkgname}" gen-completion fish > "${pkgdir}/usr/share/fish/completions/${pkgname}.fish"
  install -Dm644 "${pkgdir}/usr/share/fish/completions/${pkgname}.fish" "${pkgdir}/usr/share/fish/completions/${pkgname}.fish"
}
